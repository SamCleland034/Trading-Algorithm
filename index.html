<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time Trading Dashboard</title>
    <link rel="icon" href="stonk_image.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Font: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        table, th, td, h1, h2, p, div, span {
            font-family: inherit;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-4">
        <h1 class="text-3xl font-bold mb-4 text-center">Real-Time Trading Dashboard</h1>
        
        <!-- Portfolio Summary -->
        <div class="mb-8">
            <h2 class="text-xl font-semibold mb-2">Portfolio Summary</h2>
            <div class="bg-white p-4 rounded shadow">
                <p id="portfolio-value" class="text-lg">Total Portfolio Value: Loading...</p>
                <p id="cash-balance" class="text-lg">Cash Balance: Loading...</p>
            </div>
        </div>
        
        <!-- Positions Table -->
        <div class="mb-8">
            <h2 class="text-xl font-semibold mb-2">Current Positions</h2>
            <table id="positions-table" class="w-full bg-white rounded shadow">
                <thead>
                    <tr class="bg-gray-200">
                        <th class="p-2 text-left">Ticker</th>
                        <th class="p-2 text-left">Quantity</th>
                        <th class="p-2 text-left">Entry Price</th>
                        <th class="p-2 text-left">Current Price</th>
                        <th class="p-2 text-left">Unrealized P&L</th>
                        <th class="p-2 text-left">Return (%)</th>
                    </tr>
                </thead>
                <tbody id="positions-body"></tbody>
            </table>
        </div>
        
        <!-- Trade Log -->
        <div>
            <h2 class="text-xl font-semibold mb-2">Recent Trades</h2>
            <div id="trade-log" class="bg-white p-4 rounded shadow max-h-96 overflow-y-auto">
                <p id="trade-log-placeholder">No recent trades. Starting to fetch trade history...</p>
            </div>
        </div>
    </div>

    <script>
        const API_KEY = 'PKGJV4FWYKV0V1HX7FJX';
        const API_SECRET = 'ybZq5el0r5mZ0ct1IP7YPGf6AyzIuJ1bTV0Qup8k';
        const REST_URL = 'https://paper-api.alpaca.markets';
        const WS_URL = 'wss://stream.data.alpaca.markets/v2/sip';

        async function fetchInitialData() {
            const headers = {
                'APCA-API-KEY-ID': API_KEY,
                'APCA-API-SECRET-KEY': API_SECRET
            };

            const account = await fetch(`${REST_URL}/v2/account`, { headers })
                .then(res => res.json())
                .catch(err => console.error('Error fetching account:', err));
            if (account) {
                document.getElementById('portfolio-value').textContent = 
                    `Total Portfolio Value: $${parseFloat(account.portfolio_value).toFixed(2)}`;
                document.getElementById('cash-balance').textContent = 
                    `Cash Balance: $${parseFloat(account.cash).toFixed(2)}`;
            }

            const positions = await fetch(`${REST_URL}/v2/positions`, { headers })
                .then(res => res.json())
                .catch(err => console.error('Error fetching positions:', err));
            if (positions) updatePositionsTable(positions);

            await fetchRecentTrades();
        }

        function updatePositionsTable(positions) {
            const tbody = document.getElementById('positions-body');
            tbody.innerHTML = '';
            if (positions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="p-2 text-center">No open positions</td></tr>';
            } else {
                positions.forEach(pos => {
                    const entryPrice = parseFloat(pos.avg_entry_price);
                    const currentPrice = parseFloat(pos.current_price);
                    const returnPct = ((currentPrice - entryPrice) / entryPrice) * 100;

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="p-2">${pos.symbol}</td>
                        <td class="p-2">${pos.qty}</td>
                        <td class="p-2">$${entryPrice.toFixed(2)}</td>
                        <td class="p-2">$${currentPrice.toFixed(2)}</td>
                        <td class="p-2 ${pos.unrealized_pl >= 0 ? 'text-green-600' : 'text-red-600'}">
                            $${parseFloat(pos.unrealized_pl).toFixed(2)}
                        </td>
                        <td class="p-2 ${returnPct >= 0 ? 'text-green-600' : 'text-red-600'}">
                            ${returnPct.toFixed(2)}%
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }
        }

        async function fetchRecentTrades() {
            const headers = {
                'APCA-API-KEY-ID': API_KEY,
                'APCA-API-SECRET-KEY': API_SECRET
            };
            try {
                const response = await fetch(`${REST_URL}/v2/orders?status=filled&limit=10`, { headers });
                const orders = await response.json();
                const log = document.getElementById('trade-log');
                log.innerHTML = '';
                if (orders.length === 0) {
                    log.innerHTML = '<p class="text-gray-500">No recent trades found.</p>';
                } else {
                    orders.forEach(order => {
                        const tradeDiv = document.createElement('div');
                        tradeDiv.className = 'border-b py-2';
                        tradeDiv.innerHTML = `
                            <span class="font-semibold">${order.side.toUpperCase()}</span> 
                            ${order.filled_qty} shares of ${order.symbol} at $${parseFloat(order.filled_avg_price).toFixed(2)} 
                            on ${new Date(order.filled_at).toLocaleString()}
                        `;
                        log.appendChild(tradeDiv);
                    });
                }
            } catch (error) {
                console.error('Error fetching trades:', error);
                document.getElementById('trade-log').innerHTML = '<p class="text-red-500">Error loading trades. Check console.</p>';
            }
        }

        setInterval(fetchRecentTrades, 5 * 60 * 1000);

        function addTradeToLog(trade) {
            const log = document.getElementById('trade-log');
            const tradeDiv = document.createElement('div');
            tradeDiv.className = 'border-b py-2';
            tradeDiv.innerHTML = `
                <span class="font-semibold">${trade.side.toUpperCase()}</span> 
                ${trade.qty} shares of ${trade.symbol} at $${parseFloat(trade.price).toFixed(2)} 
                on ${new Date(trade.filled_at).toLocaleString()}
            `;
            log.prepend(tradeDiv);
            while (log.children.length > 50) log.removeChild(log.lastChild);
        }

        function checkMarketStatus() {
            fetch(`${REST_URL}/v2/clock`, {
                headers: { 'APCA-API-KEY-ID': API_KEY, 'APCA-API-SECRET-KEY': API_SECRET }
            })
            .then(res => res.json())
            .then(data => {
                const log = document.getElementById('trade-log');
                if (!data.is_open) {
                    log.innerHTML = '<p class="text-gray-500">Market closed. No real-time trades until Monday 9:30 AM EDT.</p>';
                } else if (log.children.length === 0 || log.innerHTML.includes('No recent trades')) {
                    fetchRecentTrades();
                }
            })
            .catch(err => console.error('Error checking market status:', err));
        }

        function startWebSocket() {
            const ws = new WebSocket(WS_URL);

            ws.onopen = () => {
                console.log('WebSocket connected, authenticating...');
                ws.send(JSON.stringify({
                    action: 'authenticate',
                    data: { key: API_KEY, secret: API_SECRET }
                }));
            };

            ws.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                if (msg.stream === 'authorization' && msg.data.status === 'authorized') {
                    console.log('WebSocket authenticated, subscribing...');
                    ws.send(JSON.stringify({
                        action: 'subscribe',
                        data: { trades: ['*'], account_updates: true }
                    }));
                } else if (msg.stream === 'trade_updates') {
                    const trade = msg.data.order;
                    if (trade.filled_at) {
                        addTradeToLog({
                            symbol: trade.symbol,
                            side: trade.side,
                            qty: trade.filled_qty,
                            price: trade.filled_avg_price,
                            filled_at: trade.filled_at
                        });
                    }
                } else if (msg.stream === 'account_updates') {
                    const account = msg.data;
                    document.getElementById('portfolio-value').textContent = 
                        `Total Portfolio Value: $${parseFloat(account.portfolio_value).toFixed(2)}`;
                    document.getElementById('cash-balance').textContent = 
                        `Cash Balance: $${parseFloat(account.cash).toFixed(2)}`;
                    fetchInitialData();
                }
            };

            ws.onerror = (error) => console.error('WebSocket error:', error);
            ws.onclose = () => {
                console.log('WebSocket closed. Reconnecting...');
                setTimeout(startWebSocket, 5000);
            };
        }

        fetchInitialData();
        startWebSocket();
        checkMarketStatus();
        setInterval(checkMarketStatus, 300000);
    </script>
</body>
</html>